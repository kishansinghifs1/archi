name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ── Fast feedback (parallel) ────────────────────────────────────────
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install formatting tools
        run: pip install black==24.10.0 isort==6.0.1

      - name: Check formatting with Black
        continue-on-error: true
        run: black --check .

      - name: Check import ordering with isort
        continue-on-error: true
        run: isort --check .

  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install . || true
          pip install -r requirements/requirements-base.txt
          pip install pytest

      - name: Run unit tests
        run: python -m pytest tests/unit/ -v --tb=short

  # ── Build base images (only when inputs change) ─────────────────────
  build-base-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      ARCHI_DIR: ${{ github.workspace }}/archi-local

    outputs:
      changed: ${{ steps.detect.outputs.changed }}
      tag: ${{ steps.detect.outputs.tag }}
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY" || true
          docker system prune -af || true
          df -h /

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect base image changes
        id: detect
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          MAIN_REF: main
        run: |
          set -euo pipefail
          git fetch --no-tags origin "$MAIN_REF"
          FILES="$(git diff --name-only "origin/${MAIN_REF}...HEAD" || true)"
          TAG="pr-${PR_NUMBER}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          PATTERN='^(requirements/(?:cpu|gpu)-requirementsHEADER\.txt|requirements/requirements-base\.txt|src/cli/templates/dockerfiles/base-[^/]+/Dockerfile)'
          if [[ -z "$FILES" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if echo "$FILES" | grep -E "$PATTERN" >/dev/null; then
            echo "Base image inputs changed:"
            echo "$FILES" | grep -E "$PATTERN"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Python
        if: steps.detect.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install archi CLI
        if: steps.detect.outputs.changed == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install ".[all]" || pip install .

      - name: Ensure build scripts are executable
        if: steps.detect.outputs.changed == 'true'
        run: chmod +x scripts/dev/*.sh

      - name: Build updated base images
        if: steps.detect.outputs.changed == 'true'
        run: |
          # Only build python base for PR preview (pytorch not used in smoke tests)
          scripts/dev/build_docker_images.sh -i a2rchi/a2rchi-python-base "${{ steps.detect.outputs.tag }}"

      - name: Push updated base image to Docker Hub
        if: steps.detect.outputs.changed == 'true'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          TAG: ${{ steps.detect.outputs.tag }}
        run: |
          set -euo pipefail
          echo "$DOCKERHUB_TOKEN" | docker login docker.io --username "$DOCKERHUB_USERNAME" --password-stdin
          docker push "a2rchi/a2rchi-python-base:${TAG}"

  # ── Smoke deployment + integration tests ────────────────────────────
  preview:
    runs-on: ubuntu-latest
    needs: build-base-images
    permissions:
      contents: read
      pull-requests: write
    env:
      ARCHI_DIR: ${{ github.workspace }}/archi-local
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY" || true
          docker system prune -af || true
          df -h /

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install archi CLI
        run: |
          python -m pip install --upgrade pip
          pip install ".[all]" || pip install .
          python -c "import importlib.util, mkdocs; assert importlib.util.find_spec('mkdocs.__main__'), 'mkdocs.__main__ missing'; print('mkdocs:', mkdocs.__version__)"

      - name: Install Ollama and pull model
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          for i in $(seq 1 30); do
            if curl -fsS http://localhost:11434/api/tags >/dev/null 2>&1; then
              echo "Ollama is ready"
              break
            fi
            sleep 1
          done
          ollama pull qwen3:4b

      - name: Disable Docker containerd image store
        run: |
          # Docker on ubuntu-latest uses containerd image store by default.
          # This causes "already exists" errors when multiple compose services
          # share the same image name (e.g. config-seed reuses chatbot image).
          # Must overwrite daemon.json AND remove drop-in dir to fully revert.
          echo '{"features":{"containerd-snapshotter":false}}' | sudo tee /etc/docker/daemon.json
          sudo rm -rf /etc/docker/daemon.json.d
          sudo systemctl restart docker
          docker info | grep -i "Storage Driver"

      - name: Pull updated base image from Docker Hub
        if: needs.build-base-images.outputs.changed == 'true'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          TAG: ${{ needs.build-base-images.outputs.tag }}
        run: |
          set -euo pipefail
          echo "$DOCKERHUB_TOKEN" | docker login docker.io --username "$DOCKERHUB_USERNAME" --password-stdin
          docker pull "docker.io/a2rchi/a2rchi-python-base:${TAG}"

      - name: Prepare base image references
        if: needs.build-base-images.outputs.changed == 'true'
        run: python scripts/dev/update_service_base_images.py --tag "${{ needs.build-base-images.outputs.tag }}" --switch-source dockerhub --orig-tag all

      - name: Verify MkDocs build
        run: mkdocs build --config-file docs/mkdocs.yml --strict

      - name: Clean up MkDocs build artifacts
        run: rm -rf site

      - name: Run smoke deployment
        uses: ./.github/actions/run-smoke
        with:
          deployment-name: ci-${{ github.run_id }}
          config-path: tests/pr_preview_config/pr_preview_config.yaml
          config-destination: configs/ci/ci_config.generated.yaml
          services: chatbot
          hostmode: "true"
          wait-url: http://localhost:2786/api/health
          base-url: http://localhost:2786
          extra-env: |
            ARCHI_COMPOSE_UP_FLAGS=--build --force-recreate
            SMOKE_OLLAMA_MODEL=qwen3:4b
            SMOKE_OLLAMA_URL=http://localhost:11434
            SMOKE_OLLAMA_HOST=http://localhost:11434
            SMOKE_CLEANUP=false
          use-podman: "false"

      # ── Playwright UI tests (run in same job; deployment is on localhost) ──
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install npm dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        env:
          BASE_URL: http://localhost:2786
          CI: "true"
        run: npx playwright test

      - name: Upload Playwright report
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      # ── Cleanup ─────────────────────────────────────────────────────────
      - name: Cleanup smoke deployment
        if: ${{ always() }}
        run: |
          yes | archi delete --name ci-${{ github.run_id }} || true

      - name: Cleanup local base images
        if: ${{ always() && needs.build-base-images.outputs.changed == 'true' }}
        run: |
          set -euo pipefail
          TAG="${{ needs.build-base-images.outputs.tag }}"
          echo "Cleaning up local base images with tag: $TAG"
          docker rmi "docker.io/a2rchi/a2rchi-python-base:${TAG}" || true
          echo "Cleanup complete"
